<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css"></link>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css"></link>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
</head>
<body>
<aside class="sidebar">
    <header class="sidebar__header">
        <h1>口罩即時地圖</h1>
        <div class="float-right sidebar__source">
            <em>來源：衛福部</em>
            <span class="sidebar__today" id="todayDate"></span>
        </div>
        <div class="banner">
            <img src="http://fakeimg.pl/300x166" alt="">
        </div>
        <div class="sidebar__nowLocation">
            <h3>現在位置</h3>
            <input type="text" value="" placeholder="現在位置">
            <input type="button" value="搜尋">
        </div>
        <div class="sidebar__maskFilter" id="fliterMask">
            <input type="button" value="所有口罩" id="btn__allMask">
            <input type="button" value="成人口罩" id="btn__adultMask">
            <input type="button" value="兒童口罩" id="btn__childMask">
        </div>
    </header>
    <main>
        <h2>尚有庫存店家</h2>
        <div class="sidebar__store" id="storeList">
            <!--            <article>-->
            <!--                <h4>圈圈大藥局</h4>-->
            <!--                <ul>-->
            <!--                    <li>地址：新北市</li>-->
            <!--                    <li>+886 2-2226 9636</li>-->
            <!--                    <li>今日營業時間：9am-10pm</li>-->
            <!--                </ul>-->
            <!--                <div class="sidebar__maskNum">-->
            <!--                    <div><em>成人</em> 0</div>-->
            <!--                    <div><em>兒童</em> 0</div>-->
            <!--                    <span class="sidebar__updateTime">-->
            <!--                    2020/02/08 23:35更新-->
            <!--                </span>-->
            <!--                </div>-->
            <!--            </article>-->
        </div>
    </main>
</aside>
<div id="map"></div>

<script>
    const dataJson = {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012203",
                    "name": "博荃藥局",
                    "phone": "02 -27316736",
                    "address": "台北市松山區敦化北路4巷51號",
                    "mask_adult": 0,
                    "mask_child": 0,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午休診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午休診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上休診",
                    "note": "如遇國定連續假期,藥局公休",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.544742,
                        25.050063
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012383",
                    "name": "德川中西藥局",
                    "phone": "02 -27683399",
                    "address": "台北市松山區八德路4段96號",
                    "mask_adult": 2,
                    "mask_child": 46,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午休診、星期日上午休診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午休診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上休診、星期日晚上休診",
                    "note": "",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.56066,
                        25.04836
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012409",
                    "name": "家音藥局",
                    "phone": "02 -37652080",
                    "address": "台北市松山區民生東路5段73號",
                    "mask_adult": 196,
                    "mask_child": 51,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午看診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上看診",
                    "note": "早上9:00到晚上11:00",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.558489,
                        25.058709
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012454",
                    "name": "敦北藥局",
                    "phone": "02 -27155691",
                    "address": "台北市松山區民生東路4段80巷5號",
                    "mask_adult": 0,
                    "mask_child": 6,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午看診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上看診",
                    "note": "",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.553125,
                        25.057129
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012490",
                    "name": "中美藥局",
                    "phone": "02 -27627468",
                    "address": "台北市松山區富錦街531號",
                    "mask_adult": 0,
                    "mask_child": 13,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午看診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午看診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上看診",
                    "note": "營業時間如有異動,以藥局公告為準",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.565481,
                        25.061285
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "id": "5901012507",
                    "name": "康麗藥局",
                    "phone": "02 -27174117",
                    "address": "台北市松山區南京東路3段303巷20號",
                    "mask_adult": 0,
                    "mask_child": 6,
                    "updated": "2020\/02\/09 14:36:40",
                    "available": "星期一上午看診、星期二上午看診、星期三上午看診、星期四上午看診、星期五上午看診、星期六上午看診、星期日上午休診、星期一下午看診、星期二下午看診、星期三下午看診、星期四下午看診、星期五下午看診、星期六下午看診、星期日下午休診、星期一晚上看診、星期二晚上看診、星期三晚上看診、星期四晚上看診、星期五晚上看診、星期六晚上看診、星期日晚上休診",
                    "note": "春節營業時間請電洽",
                    "custom_note": "",
                    "website": ""
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        121.546826,
                        25.05369
                    ]
                }
            }
        ]
    };
    const data = dataJson.features;
    let showMask = "";

    getTodat();
    getMap();
    updateStoreList('all');
    // const maskFilter = btnShowMask();

    function my$(id) {
        return document.getElementById(id);
    }

    // 取得今天日期
    function getTodat() {
        let Today = new Date();
        let todayDate = Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日";
        document.getElementById('todayDate').append(todayDate);
    }

    // 成人、兒童口罩篩選
    // function btnShowMask() {
    let maskBtn = my$('fliterMask').getElementsByTagName('input');
    for (let i = 0; i < maskBtn.length; i++) {
        maskBtn[i].onclick = function () {
            switch (maskBtn[i].id) {
                case 'btn__adultMask':
                    // console.log('adult');
                    // showMask = "adult";
                    updateStoreList('adult');
                    break;
                case 'btn__childMask':
                    // showMask = "child";
                    // console.log('child');
                    updateStoreList('child');
                    break;
                default:
                    // showMask = "all";
                    // console.log('all');
                    updateStoreList('all');
            }
        }
    }
    // }

    // 篩選口罩數量 2020.02.12
    function updateStoreList(showMask) {
        // my$('storeList').innerHTML = "";
        // console.log(my$('storeList').innerHTML);
        let str = "";
        // 所有口罩：預設顯示
        // 成人口罩：顯示成人口罩數量不等於 0 的店家
        let filterAdultMask = data.filter(function (item, index, array) {
            return item.properties.showMask !== 0;       // 成人口罩：顯示成人口罩數量不等於 0 的店家
        });
        // console.log(filterAdultMask);
        // console.log(filterAdultMask);
        // 兒童口罩：顯示兒童口罩數量不等於 0 的店家
        // info.mask_child !=0
        // 顯示藥局列表
        for (let i = 0; i < filterAdultMask.length; i++) {
            let storeStr = `<article>
        <h4>${filterAdultMask[i].properties.name}</h4>
            <ul>
                <li>${filterAdultMask[i].properties.address}</li>
                <li>${filterAdultMask[i].properties.phone}</li>
<!--                <li>今日營業時間：${filterAdultMask[i].properties.available}</li>-->
            </ul>
        <div class="sidebar__maskNum">
            <div><em>成人</em> ${filterAdultMask[i].properties.mask_adult}</div>
            <div><em>兒童</em> ${filterAdultMask[i].properties.mask_child}</div>
            <span class="sidebar__updateTime">
            ${filterAdultMask[i].properties.updated} 更新
        </span>
        </div>
              </article>`;
            str += storeStr
        }
        my$('storeList').innerHTML = str;

    }

    // 產生地圖
    function getMap() {
        let map = L.map('map', {
            center: [25.053144, 121.544704],
            zoom: 16
        });
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 20,
            id: 'mapbox/streets-v11',
            accessToken: 'pk.eyJ1Ijoiam9objg4OTUiLCJhIjoiY2s2ZjBpbnRlMDQxNTNlbXQzcGRmd3g0ZSJ9.CZhZ2p1dMuFgIPard8rqwg'
        }).addTo(map);

        // ICON
        let greenIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        let blueIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        let greyIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // L.marker([25.061285, 121.565481], {icon: greenIcon}).addTo(map)
        //     .bindPopup('<h1>測試藥局</h1><p>成人口罩：50<br>兒童口罩：50</p>');
        // 群組 marker
        let markers = new L.MarkerClusterGroup().addTo(map);

        // 調用遠端資料用
        // var xhr = new XMLHttpRequest();
        // xhr.open("get","https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json");
        // xhr.send();
        // xhr.onload = function () {
        //     var data = JSON.parse(xhr.responseText).features;
        //     for(let i=0;i<data.length;i++){
        //
        //     }
        // }
        //
        // 循環取得遠端資料
        for (let i = 0; i < data.length; i++) {
            let lat = data[i].geometry.coordinates[1];
            let lng = data[i].geometry.coordinates[0];
            let info = data[i].properties;
            // 如果口罩數量為0，則不顯示
            if (info.mask_adult + info.mask_child === 0) {
                continue;
            }
            // 欄位
            // info.name
            // info.phone
            // info.address
            // info.mask_adult
            // info.mask_child
            // info.updated
            // info.available
            // info.note
            //
            // map原生資訊
            // 與目前位置距離
            // 目前地址
            //
            // 地圖
            //     判斷：
            //     當前位置：紅色圖示、店家點（綠色）
            // infoWindow
            // 店名、距離當前幾km
            // 導航連結
            // *標星號
            // 側邊欄
            //     顯示字串：最後一碼…
            //     當前位置：顯示地址
            //     輸入地址 查詢
            //     列表項目
            //         店名、距離當前幾km
            //         地址
            //         電話（點選可撥打）
            //         營業時間
            //         口罩數量：成人 0 、兒童 20
            //         *標星號
            //         *導航連結

            //         距離最近：離當前位置最近：取得一定範圍內所有marker，計算與當前位置之間的差距，取最小
            //         存量最多：計算一定範圍內所有marker，口罩總數（成人+兒童）最多，取最大
            //         *已標星號
            //
            // 產生marker
            markers.addLayer(L.marker([lat, lng], {icon: info.mask_adult + info.mask_child !== 0 ? blueIcon : greyIcon})
                .bindPopup("<h1>" + info.name + "</h1><em>" + info.updated + " 更新</em><div class='map__maskNum'><div><em>成人</em> " + info.mask_adult + "</div><div><em>兒童</em> " + info.mask_child + "</div></div>"));
        }
        // map.addLayer(markers);
    }


</script>

</body>
</html>